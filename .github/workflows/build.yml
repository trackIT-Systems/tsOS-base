name: Build tsOS-base Images

on:
  push:
    tags:
      - "*"

jobs:
  release:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Create release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          prerelease: True
          generate_release_notes: True
          
  build-arm64:
    runs-on: ubuntu-24.04-arm
    needs: release
    steps:
      - name: Checkout repository
        uses: actions/checkout@v1
        with:
          submodules: recursive
          token: ${{ secrets.PAT_JONASHOECHST }}

      - name: Run tsOS-base.Pifile
        uses: Nature40/pimod@v0.9.1
        with:
          pifile: tsOS-base.Pifile

      - name: Package tsOS-base-arm64-${{github.ref_name}}.zip
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          mv tsOS-base-arm64.img tsOS-base-arm64-${{github.ref_name}}.img
          zip tsOS-base-arm64-${{github.ref_name}}.zip tsOS-base-arm64-${{github.ref_name}}.img

      - name: Upload Release tsOS-base-arm64-${{github.ref_name}}.zip
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload ${{github.ref_name}} tsOS-base-arm64-${{github.ref_name}}.zip

      - name: Get latest stable release
        id: get_latest_release
        run: |
          LATEST_RELEASE=$(gh release list --exclude-pre-releases --limit 1 --json tagName --jq '.[0].tagName' || echo "")
          echo "latest_release=$LATEST_RELEASE" >> $GITHUB_OUTPUT
          echo "Latest stable release: $LATEST_RELEASE"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download previous release image
        if: steps.get_latest_release.outputs.latest_release != ''
        run: |
          PREVIOUS_TAG="${{ steps.get_latest_release.outputs.latest_release }}"
          echo "Downloading tsOS-base-arm64-${PREVIOUS_TAG}.zip"
          gh release download ${PREVIOUS_TAG} -p "tsOS-base-arm64-${PREVIOUS_TAG}.zip"
          unzip "tsOS-base-arm64-${PREVIOUS_TAG}.zip"
          echo "Downloaded and extracted: tsOS-base-arm64-${PREVIOUS_TAG}.img"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate update file with pidiff
        if: steps.get_latest_release.outputs.latest_release != ''
        run: |
          PREVIOUS_TAG="${{ steps.get_latest_release.outputs.latest_release }}"
          CURRENT_TAG="${{ github.ref_name }}"
          
          # Run pidiff with exclude-from to use .pidiffignore
          docker run --rm --privileged \
            -v $PWD:/pimod \
            nature40/pimod:v0.9.1 \
            pidiff.sh --tar \
            --partition=2 \
            --exclude-from=.pidiffignore \
            --output="tsOS-base-arm64-update-${PREVIOUS_TAG}-to-${CURRENT_TAG}.batch" \
            "tsOS-base-arm64-${PREVIOUS_TAG}.img" \
            "tsOS-base-arm64.img"

      - name: Upload update file to release
        if: steps.get_latest_release.outputs.latest_release != '' && startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PREVIOUS_TAG="${{ steps.get_latest_release.outputs.latest_release }}"
          CURRENT_TAG="${{ github.ref_name }}"
          gh release upload ${CURRENT_TAG} "tsOS-base-arm64-update-${PREVIOUS_TAG}-to-${CURRENT_TAG}.tar"
