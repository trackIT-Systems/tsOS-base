#!/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

echo "Brovi Startup: Checking for Huawei E3372-325 devices..."

# Find all Brovi devices and exit if none found
mapfile -t DEVICES < <(lsusb -d 3566:2001)
if [[ ${#DEVICES[@]} -eq 0 ]]; then
    echo "No Brovi devices detected. Nothing to do."
    exit 0
fi

echo "Found ${#DEVICES[@]} Brovi device(s)"

# Collect unique USB hub locations
declare -A HUBS
for line in "${DEVICES[@]}"; do
    set -- $line
    bus=$((10#$2))  # Strip leading zeros from bus number (001 -> 1)
    dev=${4%:}      # Strip colon from device number
    
    echo "  Device: Bus $2 Device $dev"
    
    # Find device path in sysfs
    for path in /sys/bus/usb/devices/${bus}-*; do
        [[ -e "$path" ]] || continue
        
        # Extract hub location (e.g., "1-1" from "1-1.3")
        port=$(basename "$path")
        hub=${port%.*}  # Remove everything after last dot
        
        if [[ "$hub" =~ ^[0-9]+-[0-9]+$ ]]; then
            HUBS["$hub"]=1
            echo "    -> USB path: $port (hub: $hub)"
            break
        fi
    done
done

# Power cycle hubs
if [[ ${#HUBS[@]} -gt 0 ]]; then
    echo ""
    echo "Power cycling ${#HUBS[@]} USB hub location(s): ${!HUBS[*]}"
    for hub in "${!HUBS[@]}"; do
        echo "  -> Cycling hub $hub..."
        uhubctl -l "$hub" -d 0 -a cycle
    done
    echo ""
    echo "Power cycle complete. Devices will re-enumerate."
    echo "Mode switching will be handled by udev rules (40-huawei.rules)."
else
    echo ""
    echo "Warning: Could not determine USB hub locations"
    echo "Power cycling skipped."
fi

echo "Finished."
