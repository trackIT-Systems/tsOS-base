#!/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

USB_ID=$(basename $DEVPATH)

{
IC=$( grep -h .  /sys$DEVPATH/*:1.0/bInterfaceClass )
echo "Got bInterfaceClass on 1st port $IC"

case $IC in
08) 
    echo "Storage MODE"
    ;;
e0)
    echo "Already RNDIS"
    LOCKFILE=/var/run/brovi.$USB_ID.lock

    if [[ -e $LOCKFILE ]]; then    
        LOCKFILE_AGE=$(( $(date +%s ) - $(stat  $LOCKFILE -c %Y) )) 
        echo LOCKFILE_AGE=$LOCKFILE_AGE
    fi

    if [[ -n $LOCKFILE_AGE ]] && [[ $LOCKFILE_AGE -lt  10 ]]; then
        echo Device was switched VERY recently, noop
    else
        set > $LOCKFILE

        usb_modeswitch -b $BUSNUM -g $DEVNUM -v $ID_VENDOR_ID -p $ID_MODEL_ID -W -R -w 400
        usb_modeswitch -b $BUSNUM -g $DEVNUM -v $ID_VENDOR_ID -p $ID_MODEL_ID -W -R
    fi
    ;;
ff)
    echo "Serial Port"
    ;;
*)
    echo "Unknown mode"
    ;;
esac

} | logger -t brovi

exit 0
